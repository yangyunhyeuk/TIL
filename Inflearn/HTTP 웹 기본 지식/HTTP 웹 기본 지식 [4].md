# HTTP 헤더 [2] - 캐시와 조건부 요청

- 캐시가 없는 경우
    - 웹 브라우저에서 star.jpg 요청 시 서버에서 star.jpg 응답을 내려줄 때 
    http 헤더 : 0.1m, http 바디 : 1.0m 크기의 용량을 돌려준다.
    - 2번째 요청에서도 마찬가지로 똑같은 용량의 데이터를 다시 돌려준다.
    - 데이터가 변경되지 않아도 계속 네트워크를 통해서 데이터를 다운로드 받아야 한다.
    - 인터넷 네트워크는 매우 느리고 빘다ㅏ.
    - 브라우저 로딩 속도가 느리다.

- 캐시를 적용한 경우
    - 웹 브라우저에는 캐시 데이터를 저장하는 저장소가 존재하여 응답 결과를 여기에 저장한다.
    - 캐시 덕분에 캐시 가능 시간 동안에는 네트워크를 사용하지 않아도 된다.
    - 비싼 네트워크 사용량을 줄여 로딩 속도가 매우 빠르다.

- 캐시 시간이 초과한 경우
    - 캐시 유효 시간이 초과하면 서버를 통해 데이터를 다시 조회하고 캐시를 갱신하며 이 때 네트워크 다운로드가 물론 발생한다.

### 캐시 시간 초과

캐시 유효 시간이 초과하여 ㅅ버ㅓ에 다시 요청하면 다음의 2가지 상황이 발생한다. 

1. 서버에서 기존 데이터를 변경한다. 
2. 서버에서 기존 데이터를 변경하지 않는다. 

- 생각해보면 데이터를 전송하는 대신에 저장해 두었던 캐시를 재사용할 수 있다. 여기서 클라이언트의 데이터와 서버의 데이터가 같다는 사실을 확인할 수 있는 방법이 필요한 것이다.
- 그리하여 검증 헤더를 추가한다.

cache-control 헤더 요소를 통해 캐시 지속 시간을 설정하고

Last-Modified 헤더 요소를 통해 데이터의 최종 수정일을 설정할 수 있다. 

설정 시간인 60초가 지날 경우 Last-Modified 헤더 요소를 서버에 전송하면, 

서버에서 해당 데이터를 수정되지 않았을 경우 혹은 각 Last-Modified 헤더 요소 데이터가 

일치하는 경우 서버에서 304 Not Modified http 통신을 다시 보낸다. 

단, 여기서 http body 데이터를 제외하고 재전송한다. 그럼 네트워크 부화가 확 줄게 된다. 

그럼 캐시 저장소 측에서는 데이터를 다시 세팅하여 사용한다. 

캐시 유효 시간이 초과해도 Last-Modified와 if-modified-since를 이용하여 

body 데이터없이 0.1m의 헤더 데이터만으로 캐시 저장소에 있는 데이터를 재활용할 수 있다. 

---

### 캐시와 조건부 요청 헤더

1. Cache Control
    1. Cache-Control: max-age
        1. 캐시 유효 시간, 초 단위
    2. Cache-Control: no-cache
        1. 데이터는 캐시해도 되지만, 항상 원 서버에 검증하고 사용
            
            ⇒ 중간에 캐시 프록시 서버가 아닌 origin 서버에서의 행위를 의미
            
    3. Cache-Control: no-store
        1. 데이터에 민감한 정보가 있어 저장하면 안됨
        
2. Pragme
    1. http 1.0의 하위 호환으로 지금은 거의 사용하지 않는다. 
    
3. Expires
    1. 캐시 만료일을 정확한 날짜로 지정할 수 있다. 
    2. Cache-Control: max-age보다 덜 유연하다. 

---

## 프록시 캐시

프록시 캐시 서버란 원 서버에 직접 접근하며 걸리는 시간을 절감에 큰 도움이 된다. 

원 서버와 클라이언트의 웹 브라우저 사이에 프록시 캐시 서버를 배치하여 응답시간 대폭 감소

Cache-Control (캐시 지시어)

- Cache-Control: public
    - 응답이 public 캐시에 저장되어도 된다.
- Cache-Control: private
    - 응답이 해당 사용자만을 위한 것으로 private  캐시에 저장해야 한다.
- Cache-Control: s-maxage
    - 프록시 캐시에만 적용되는 max-age
- Age: 60 (http 헤더)
    - 오리진 서버에서 응답 후 프록시 캐시 내에 머문 시간(초)

---

## Cache-Control (확실한 캐시 무효화 응답)

- Cache-Control: no-cache, no-store, must-revaildate
- Pragma: no-cache
    - http 1.0(과거 브라우저)에서 혹시 요청이 올 지 모르니, 넣어주는 것
    
1. Cache-Control: no-cache
    1. 데이터는 캐시해도 되지만, 항상 원 서버에 검증하고 사용
2. Cache-Control: no-store
    1. 데이터에 민감한 정보가 있어, 저장하면 안됨
3. Cache-Control: must-revaildate
    1. 캐시 만료 후에 최초 조회할 시 원 서버에 검증해야 한다. 
4. Pragma: no-cache
    1. http 1.0의 하위 호환으로 지금은 거의 사용하지 않는다. 

Q. Cache-Control: no-cache하는데 왜 또 Cache-Control: must-revaildate하나요?

⇒ 계좌 이체의 경우 화면 갱신을 하였을 때, 프록시 캐시와 원 서버 간에 순간 네트워크가 단절될 경우를 대비하여 넣어주는 것이다. 이 때는 이전의 데이터를 보여주기 보다, 이슈를 발생시키는 게 옳기 때문이다.
